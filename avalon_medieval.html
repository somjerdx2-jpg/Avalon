<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Avalon ‚Äî Medieval Offline (Pass-and-Play)</title>

<!-- Google Font (will load if online; fallback to system) -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,700&display=swap" rel="stylesheet">

<style>
:root{
  --bg-1: #05060a;
  --bg-2: #081022;
  --card:#0b1220;
  --gold-1: #c9a34a;
  --gold-2: #f9e6a0;
  --muted:#b6c0c9;
  --accent:#7dd3fc;
  --danger:#d04b4b;
  --success:#57b77a;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Cinzel", "Playfair Display", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:var(--gold-2);background:radial-gradient(1200px 600px at 10% 10%, rgba(18,24,34,0.6), transparent 10%), linear-gradient(180deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
.app{max-width:980px;margin:18px auto;padding:18px}
.header{display:flex;gap:14px;align-items:center}
.logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,#071428,#193045);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--gold-2);font-size:20px;border:2px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.6) inset, 0 8px 30px rgba(0,0,0,0.6)}
.title-block h1{margin:0;font-size:20px;letter-spacing:0.06em}
.subtitle{color:var(--muted);font-size:13px;margin-top:4px}

/* Main card style */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));border-radius:16px;padding:14px;margin-top:12px;border:1px solid rgba(255,255,255,0.03);box-shadow: 0 8px 30px rgba(2,6,12,0.6)}
.flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

/* Inputs */
.select, .input{background:transparent;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.04);color:var(--gold-2);min-width:160px}
.btn{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));border:1px solid rgba(255,255,255,0.03);padding:10px 14px;border-radius:12px;color:var(--gold-2);font-weight:700;cursor:pointer;backdrop-filter: blur(2px)}
.btn.primary{background:linear-gradient(180deg,#d9b86a,#b07e2e);color:#101010;box-shadow:0 8px 18px rgba(176,126,46,0.12);border:0}
.small{padding:6px 8px;font-size:13px}

/* Players tokens */
.tokens{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.token{min-width:90px;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.18));border:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between;gap:10px}
.token .name{font-weight:700}
.token.selected{outline:3px solid rgba(201,163,74,0.14);box-shadow:0 10px 30px rgba(0,0,0,0.6) inset;transform:translateY(-6px)}

/* Role card flip */
.flip-card{background:transparent;width:260px;height:150px;perspective:1000px;margin:18px auto}
.flip-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .8s ease}
.flip-card.show .flip-inner{transform:rotateY(180deg)}
.flip-front, .flip-back{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px;border:1px solid rgba(255,255,255,0.04)}
.flip-front{background:linear-gradient(180deg,#10212a,#07121a);color:var(--muted);font-weight:700}
.flip-back{background:linear-gradient(180deg,#2b1a0f,#2a1b12);color:var(--gold-2);transform:rotateY(180deg);box-shadow:0 12px 40px rgba(0,0,0,0.6)}

/* role icon */
.role-icon{width:48px;height:48px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.03)}

/* mission tracker */
.mission-track{display:flex;gap:10px;align-items:center;margin-top:10px}
.mission-dot{width:36px;height:36px;border-radius:999px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-weight:800;border:2px solid rgba(255,255,255,0.03)}
.mission-dot.empty{opacity:0.35}
.mission-dot.success{background:linear-gradient(180deg,#bff0d1,#57b77a);color:#06210a;border:0}
.mission-dot.fail{background:linear-gradient(180deg,#ffd6d6,#d04b4b);color:#2b0303;border:0}

/* voting modal style */
.modal{position:fixed;inset:0;background:rgba(2,6,12,0.6);display:flex;align-items:center;justify-content:center;z-index:60}
.vote-box{background:linear-gradient(180deg,#07121a,#0b1220);padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);min-width:320px;text-align:center}
.vote-buttons{display:flex;gap:12px;justify-content:center;margin-top:12px}
.vote-btn{padding:14px 18px;border-radius:12px;font-weight:900;cursor:pointer;border:0}
.vote-btn.approve{background:linear-gradient(180deg,#c7f9dd,#57b77a);color:#042}
.vote-btn.reject{background:linear-gradient(180deg,#ffd0d0,#d04b4b);color:#3a0202}

/* small screens tweak */
@media (max-width:640px){
  .flip-card{width:94%;height:140px}
  .token{min-width:120px}
}

/* nice transitions */
.hidden{display:none}
.fade{animation:fadeIn .45s ease both}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* footer */
.footer{color:var(--muted);font-size:13px;margin-top:12px;text-align:center}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="logo">AV</div>
    <div class="title-block">
      <h1>Avalon ‚Äî Medieval Offline (Pass & Play)</h1>
      <div class="subtitle">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPad ‚Äî ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÅ‡∏ö‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
    </div>
  </div>

  <!-- Setup -->
  <div class="card" id="setupCard">
    <div class="flex" style="justify-content:space-between;align-items:center;">
      <div style="flex:1">
        <div class="small-muted" style="color:var(--muted);font-size:13px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
        <select id="playerCount" class="select small">
          <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
        </select>
      </div>
      <div style="flex:2">
        <div class="small-muted" style="color:var(--muted);font-size:13px">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)</div>
        <input id="namesInput" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô Anna,Bob,Charlie" />
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <button id="startBtn" class="btn primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‚Äî ‡πÅ‡∏à‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</button>
        <div style="color:var(--muted);font-size:13px">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏ô iPad ‚Üí ‡πÅ‡∏ä‡∏£‡πå ‚Üí Add to Home Screen</div>
      </div>
    </div>
    <div style="margin-top:12px;color:var(--muted);font-size:13px">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡πÅ‡∏≠‡∏û‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Pass-and-Play ‚Äî ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡∏ú‡∏•‡∏±‡∏î‡∏Å‡∏±‡∏ô‡∏î‡∏π‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏ö‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
  </div>

  <!-- Role reveal -->
  <div class="card hidden" id="rolesCard">
    <div class="center">
      <div style="display:flex;gap:18px;align-items:center;justify-content:center;flex-direction:column">
        <div id="revealTitle" style="font-size:18px;font-weight:900">‡πÅ‡∏à‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÅ‡∏ö‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
        <div class="flip-card" id="flipCard">
          <div class="flip-inner" id="flipInner">
            <div class="flip-front">
              <div style="font-size:14px;color:var(--muted)">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
              <div style="font-size:20px;font-weight:900;margin-top:6px" id="revealName">Player 1</div>
              <div style="height:10px"></div>
              <div style="font-size:13px;color:var(--muted)">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÅ‡∏ö‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
            </div>
            <div class="flip-back">
              <div class="role-icon" id="roleIcon">üîÆ</div>
              <div style="font-size:18px;font-weight:900" id="roleTitle">Merlin</div>
              <div style="font-size:13px;color:var(--muted);margin-top:6px;text-align:center" id="roleDesc">Merlin ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏¢‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏Ñ‡∏£ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á Assassin</div>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:10px">
          <button id="showRoleBtn" class="btn">‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</button>
          <button id="nextRevealBtn" class="btn primary hidden">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
        </div>
        <div style="color:var(--muted);font-size:13px">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏™‡πà‡∏á iPad ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ / ‡∏´‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
      </div>
    </div>
  </div>

  <!-- Game area -->
  <div class="card hidden" id="gameCard">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:13px;color:var(--muted)">‡∏ú‡∏π‡πâ‡∏ô‡∏≥ / ‡∏£‡∏≠‡∏ö</div>
        <div id="roundInfo" style="font-weight:900;font-size:18px">Round 1 ‚Äî Leader: Player 1</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:var(--muted)">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
        <div style="font-weight:900"><span id="succCount">0</span> ‚úì &nbsp;|&nbsp; <span id="failCount">0</span> ‚úñ</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-size:14px;color:var(--muted)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° (‡πÅ‡∏ï‡∏∞ token ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</div>
        <div class="mission-track" id="missionTrack">
          <div class="mission-dot empty">1</div>
          <div class="mission-dot empty">2</div>
          <div class="mission-dot empty">3</div>
          <div class="mission-dot empty">4</div>
          <div class="mission-dot empty">5</div>
        </div>
      </div>

      <div class="tokens" id="playersList" style="margin-top:10px"></div>

      <div style="display:flex;gap:10px;margin-top:12px;align-items:center">
        <div>‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <strong id="teamSize">2</strong></div>
        <button id="nominateBtn" class="btn primary">‡πÄ‡∏™‡∏ô‡∏≠‡∏ó‡∏µ‡∏°</button>
        <div id="nomNote" style="color:var(--muted)"></div>
      </div>
    </div>

    <!-- Voting area (private modal) -->
    <div id="votingArea" class="hidden" style="margin-top:12px">
      <div style="color:var(--muted);font-size:13px">‡∏ó‡∏µ‡∏°‡∏ñ‡∏π‡∏Å‡πÄ‡∏™‡∏ô‡∏≠: <span id="proposedTeam"></span></div>
      <div style="margin-top:8px">
        <button id="startVoteBtn" class="btn primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏ß‡∏ï (private)</button>
      </div>
      <div id="voteResults" class="small" style="margin-top:10px;color:var(--muted)"></div>
    </div>

    <!-- Mission area -->
    <div id="missionArea" class="hidden" style="margin-top:12px">
      <div style="font-weight:900;font-size:16px">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ‚Äî ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡∏°‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (private)</div>
      <div style="margin-top:10px">
        <button id="startMissionBtn" class="btn primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
      </div>
      <div id="missionResults" class="small" style="margin-top:10px;color:var(--muted)"></div>
    </div>

    <div id="endArea" class="hidden" style="margin-top:12px;text-align:center">
      <div style="font-size:20px;font-weight:900" id="endText">Game Over</div>
      <div style="margin-top:8px;color:var(--muted)" id="endNote"></div>
      <div style="margin-top:12px"><button id="restartBtn" class="btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button></div>
    </div>
  </div>

  <div class="footer">‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô single-file HTML ‚Äî ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏ô iPad ‡πÅ‡∏•‡πâ‡∏ß Add to Home Screen</div>
</div>

<!-- Voting modal (hidden by default) -->
<div id="modalRoot" class="hidden"></div>

<script>
/* ======= Game logic (same base as before, with improved UI hooks) ======= */
const roleSets = {
  5: ['Merlin','Assassin','Loyal','Loyal','Minion'],
  6: ['Merlin','Assassin','Loyal','Loyal','Minion','Minion'],
  7: ['Merlin','Percival','Assassin','Loyal','Loyal','Minion','Minion'],
  8: ['Merlin','Percival','Assassin','Morgana','Loyal','Loyal','Minion','Minion'],
  9: ['Merlin','Percival','Assassin','Morgana','Mordred','Loyal','Loyal','Minion','Minion'],
 10: ['Merlin','Percival','Assassin','Morgana','Mordred','Oberon','Loyal','Loyal','Minion','Minion']
};
const missionSizes = {5:[2,3,2,3,3],6:[2,3,4,3,4],7:[2,3,3,4,4],8:[3,4,4,5,5],9:[3,4,4,5,5],10:[3,4,4,5,5]};

let players = [], roles = [], playerCount = 5;
let currentReveal = 0, leaderIndex = 0, roundNumber = 1;
let selectedTeam = [], votes = [], missionVotes = [];
let successCount = 0, failCount = 0, proposalFails = 0;

const $ = id => document.getElementById(id);
const startBtn = $('startBtn');
startBtn.onclick = startGame;

function startGame(){
  playerCount = parseInt($('playerCount').value);
  const namesRaw = $('namesInput').value.trim();
  players = [];
  if(namesRaw){
    const arr = namesRaw.split(',').map(s=>s.trim()).filter(s=>s);
    for(let i=0;i<playerCount;i++) players.push(arr[i]||('Player '+(i+1)));
  } else {
    for(let i=0;i<playerCount;i++) players.push('Player '+(i+1));
  }
  roles = assignRoles(playerCount);
  currentReveal = 0; leaderIndex = 0; roundNumber = 1; successCount=0; failCount=0; proposalFails=0;
  $('setupCard').classList.add('hidden');
  $('rolesCard').classList.remove('hidden');
  $('gameCard').classList.remove('hidden');
  showReveal();
  setupPlayersList();
  updateRoundUI();
}

function assignRoles(n){
  const base = roleSets[n] ? [...roleSets[n]] : roleSets[5];
  for(let i=base.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[base[i],base[j]]=[base[j],base[i]]}
  return base;
}

function showReveal(){
  $('revealName').textContent = players[currentReveal];
  $('flipCard').classList.remove('show');
  $('roleIcon').textContent = 'üîÆ';
  $('roleTitle').textContent='‚Äî';
  $('roleDesc').textContent='‡πÅ‡∏ï‡∏∞ "‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î';
  $('showRoleBtn').classList.remove('hidden');
  $('nextRevealBtn').classList.add('hidden');
}

$('showRoleBtn').onclick = ()=>{
  const r = roles[currentReveal];
  // populate back
  $('roleIcon').textContent = roleIcon(r);
  $('roleTitle').textContent = r;
  $('roleDesc').textContent = describeRole(r);
  // flip animation
  document.getElementById('flipInner').style.transform = 'rotateY(180deg)';
  // show next
  $('showRoleBtn').classList.add('hidden');
  $('nextRevealBtn').classList.remove('hidden');
};

$('nextRevealBtn').onclick = ()=>{
  currentReveal++;
  document.getElementById('flipInner').style.transform = 'none';
  if(currentReveal>=playerCount){
    $('rolesCard').classList.add('hidden');
    alert('‡πÅ‡∏à‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å');
  } else showReveal();
};

function roleIcon(r){
  const map = {'Merlin':'üìú','Percival':'üïØÔ∏è','Assassin':'üó°Ô∏è','Morgana':'üé≠','Mordred':'üï∂Ô∏è','Oberon':'üïµÔ∏è','Loyal':'üõ°Ô∏è','Minion':'üî∫'};
  return map[r]||'‚ùî';
}

function describeRole(r){
  const desc = {
    'Merlin':'Merlin ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏¢‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏Ñ‡∏£ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å Assassin ‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ',
    'Percival':'‡∏≠‡∏≤‡∏à‡πÄ‡∏´‡πá‡∏ô Merlin ‡∏´‡∏£‡∏∑‡∏≠ Morgana ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á Merlin',
    'Assassin':'‡∏™‡∏≤‡∏¢‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ü‡πà‡∏≤ Merlin ‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏Å‡∏°',
    'Morgana':'‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÄ‡∏ò‡∏≠‡∏Ñ‡∏∑‡∏≠ Merlin',
    'Mordred':'‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏¢‡∏•‡∏±‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢ Merlin',
    'Oberon':'‡∏™‡∏≤‡∏¢‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏ï‡∏±‡∏ß‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏•‡∏±‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
    'Loyal':'Resistance ‚Äî ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
    'Minion':'Spy ‚Äî ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÑ‡∏î‡πâ'
  };
  return desc[r]||r;
}

function setupPlayersList(){
  const list = $('playersList');
  list.innerHTML='';
  players.forEach((p,idx)=>{
    const el = document.createElement('div');
    el.className='token';
    el.innerHTML = `<div class="name">${p}</div><div class="idx">#${idx+1}</div>`;
    el.dataset.idx = idx;
    el.onclick = ()=>{
      // only allow selecting if current leader is making choices (no hard lock here)
      const need = missionSizes[playerCount][roundNumber-1] || 2;
      if(el.classList.contains('selected')){
        el.classList.remove('selected');
        selectedTeam = selectedTeam.filter(i=>i!==idx);
      } else {
        if(selectedTeam.length>=need){
          // flash
          el.animate([{transform:'translateY(-4px)'},{transform:'translateY(0)'}],{duration:200});
          return;
        }
        el.classList.add('selected');
        selectedTeam.push(idx);
      }
      $('teamSize').textContent = need;
    };
    list.appendChild(el);
  });
  selectedTeam=[];
  $('nomNote').textContent='';
}

$('nominateBtn').onclick = ()=>{
  const need = missionSizes[playerCount][roundNumber-1] || 2;
  if(selectedTeam.length!==need){ $('nomNote').textContent=`‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${need} ‡∏Ñ‡∏ô ‚Äî ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedTeam.length} ‡∏Ñ‡∏ô`; return; }
  $('proposedTeam').textContent = selectedTeam.map(i=>players[i]).join(', ');
  $('votingArea').classList.remove('hidden');
  $('startVoteBtn').classList.remove('hidden');
  $('voteResults').textContent='';
  votes=[];
};

$('startVoteBtn').onclick = ()=>{
  $('startVoteBtn').classList.add('hidden');
  beginPrivateVoting();
};

let votingTurn = 0;
function beginPrivateVoting(){
  votingTurn = 0; votes=[];
  nextVoteTurn();
}

function nextVoteTurn(){
  if(votingTurn>=playerCount){
    finishVoting();
    return;
  }
  const playerName = players[votingTurn];
  showVoteModal(playerName, (approved)=>{
    votes.push(approved ? 'approve' : 'reject');
    votingTurn++;
    nextVoteTurn();
  });
}

function finishVoting(){
  const approves = votes.filter(v=>v==='approve').length;
  const rejects = votes.length - approves;
  $('voteResults').textContent = `‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï: ‡∏ú‡πà‡∏≤‡∏ô ${approves} ‚Äî ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ${rejects}`;
  if(approves>rejects){
    $('nomNote').textContent = '‡∏ó‡∏µ‡∏°‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï ‚Äî ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à';
    $('missionArea').classList.remove('hidden');
    $('votingArea').classList.add('hidden');
  } else {
    $('nomNote').textContent = '‡∏ó‡∏µ‡∏°‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ‚Äî ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥';
    proposalFails++;
    leaderIndex = (leaderIndex+1)%playerCount;
    if(proposalFails>=5){ endGame('spies','5 ‡πÄ‡∏™‡∏ô‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‚Äî Spies ‡∏ä‡∏ô‡∏∞!'); return; }
    // reset selection
    document.querySelectorAll('.token.selected').forEach(el=>el.classList.remove('selected'));
    selectedTeam=[];
    updateRoundUI();
  }
}

/* modal vote */
function showVoteModal(playerName, cb){
  const root = $('modalRoot');
  root.innerHTML = '';
  root.classList.remove('hidden');
  const div = document.createElement('div');
  div.className='modal fade';
  div.innerHTML = `
    <div class="vote-box fade">
      <div style="font-weight:900;font-size:18px;margin-bottom:6px">${playerName}</div>
      <div style="color:var(--muted)">‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏™‡∏ô‡∏≠ ‚Äî (Private)</div>
      <div class="vote-buttons" style="margin-top:14px">
        <button class="vote-btn approve">‡∏ú‡πà‡∏≤‡∏ô</button>
        <button class="vote-btn reject">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</button>
      </div>
      <div style="margin-top:10px;color:var(--muted);font-size:13px">‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
    </div>`;
  root.appendChild(div);
  const approveBtn = div.querySelector('.approve');
  const rejectBtn = div.querySelector('.reject');
  approveBtn.onclick = ()=>{ root.classList.add('hidden'); root.innerHTML=''; cb(true); };
  rejectBtn.onclick = ()=>{ root.classList.add('hidden'); root.innerHTML=''; cb(false); };
}

/* Mission voting (private for team members) */
$('startMissionBtn').onclick = ()=>{ beginMissionVoting(); };
let missionTurn=0;
function beginMissionVoting(){
  missionTurn=0; missionVotes=[]; $('missionResults').textContent='';
  nextMissionTurn();
}
function nextMissionTurn(){
  if(missionTurn>=selectedTeam.length){
    const fails = missionVotes.filter(v=>v==='fail').length;
    const succ = missionVotes.length - fails;
    $('missionResults').textContent = `‡∏ú‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${succ} ‚Äî ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${fails}`;
    if(fails===0) successCount++; else failCount++;
    updateMissionTrack();
    // reset selection and advance
    document.querySelectorAll('.token.selected').forEach(el=>el.classList.remove('selected'));
    selectedTeam=[]; proposalFails=0;
    checkGameEnd();
    leaderIndex = (leaderIndex+1)%playerCount; roundNumber++;
    updateRoundUI();
    return;
  }
  const idx = selectedTeam[missionTurn];
  const name = players[idx];
  const role = roles[idx];
  const spyRoles = ['Minion','Assassin','Morgana','Mordred','Oberon'];
  if(spyRoles.includes(role)){
    // private prompt
    showVoteModal(name, (approved)=>{
      // here approve = success, reject = fail
      missionVotes.push(approved ? 'success' : 'fail');
      missionTurn++; nextMissionTurn();
    });
  } else {
    // auto success for Loyal
    alert(`${name} ‡πÄ‡∏õ‡πá‡∏ô Resistance ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`);
    missionVotes.push('success');
    missionTurn++; nextMissionTurn();
  }
}

function updateRoundUI(){
  $('leaderName')?.remove();
  $('roundInfo').textContent = `Round ${roundNumber} ‚Äî Leader: ${players[leaderIndex]}`;
  $('teamSize').textContent = missionSizes[playerCount][roundNumber-1] || 2;
  $('succCount').textContent = successCount;
  $('failCount').textContent = failCount;
  // update leader highlight maybe (not implemented visual leader token)
}

function updateMissionTrack(){
  const track = $('missionTrack');
  const dots = track.querySelectorAll('.mission-dot');
  for(let i=0;i<dots.length;i++){
    if(i < successCount + failCount){
      const idx = i+1;
      // determine if success or fail for each mission index? simple: fill successes then fails
      if(i < successCount) { dots[i].className='mission-dot success'; dots[i].textContent = '‚úì'; }
      else { dots[i].className='mission-dot fail'; dots[i].textContent = '‚úñ'; }
    }
  }
}

/* end game logic including assassin guess */
function checkGameEnd(){
  if(successCount>=3){
    const assassinIndex = roles.findIndex(r=>r==='Assassin');
    if(assassinIndex>=0){
      const guess = prompt(`Resistance ‡πÑ‡∏î‡πâ 3 ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ‚Äî Assassin (${players[assassinIndex]}) ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡∏≤‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô Merlin\n‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ (exact):`);
      const merlinIndex = roles.findIndex(r=>'Merlin'===r);
      if(guess && players[merlinIndex]===guess.trim()){
        endGame('spies','Assassin guessed Merlin correctly ‚Äî Spies win!');
        return;
      } else {
        endGame('resistance','Assassin guessed wrong ‚Äî Resistance win!');
        return;
      }
    } else {
      endGame('resistance','Resistance reached 3 successful missions');
      return;
    }
  }
  if(failCount>=3){ endGame('spies','Spies achieved 3 failing missions'); return; }
}

function endGame(winner,note){
  $('endArea').classList.remove('hidden');
  $('endText').textContent = winner==='resistance' ? 'Resistance ‡∏ä‡∏ô‡∏∞!' : 'Spies ‡∏ä‡∏ô‡∏∞!';
  $('endNote').textContent = note + ' ‚Äî ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ' + players.map((p,i)=>`${p}=${roles[i]}`).join(', ');
  $('gameCard').classList.add('hidden');
}

$('restartBtn').onclick = ()=>{ location.reload(); };

</script>
</body>
</html>
